<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Cluster"
        xmlns="http://ibatis.apache.org/mapping"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <alias>
    <typeAlias alias="Cluster" type="prj_BIZ_System.Models.ClusterModel"/>
    <typeAlias alias="ClusterInfo" type="prj_BIZ_System.Models.ClusterInfoModel"/>
    <typeAlias alias="ClusterFile" type="prj_BIZ_System.Models.ClusterFileModel"/>
    <typeAlias alias="ClusterMember" type="prj_BIZ_System.Models.ClusterMemberModel"/>
  </alias>

  <statements>

    <select id="SelectClusterInfo" resultMap="ClusterInfo-result" parameterClass="ClusterInfo">
      SELECT *
      FROM public.cluster_info
      <dynamic prepend="where">
        <isNotEmpty prepend="and" property="cluster_no">
          cluster_no = $cluster_no$
        </isNotEmpty>
        <isNotEmpty prepend="and" property="user_id">
          user_id = #user_id#
        </isNotEmpty>
        <isNotEmpty prepend="and" property="cluster_name">
          cluster_name = #cluster_name#
        </isNotEmpty>
      </dynamic>
    </select>

    <select id="SelectClusterInfoList" resultMap="ClusterInfo-result" parameterClass="ClusterInfo">
      SELECT *
      FROM public.cluster_info
      <dynamic prepend="where">
        <isNotEmpty prepend="and" property="user_id">
          user_id = #user_id#
        </isNotEmpty>
      </dynamic>
    </select>

    <select id="SelectClusterList" resultMap="Cluster-result" parameterClass="Cluster">
      SELECT *
      FROM public.cluster_member
      INNER JOIN cluster_info
      ON cluster_member.cluster_no = cluster_info.cluster_no
      where ( cluster_enable = '1' or cluster_enable = '2')
      <dynamic prepend="">      
        <isNotEmpty prepend="and" property="user_id">
          cluster_member.user_id = #user_id#
        </isNotEmpty>
        <isNotEmpty prepend="and" property="enable">
          "enable" = #enable#
        </isNotEmpty>
        <isNotEmpty prepend="and" property="limit">
          "limit" = #limit#
        </isNotEmpty>
      </dynamic>
    </select>

    <!--查詢聚落(手機)-->
    <select id="SelectClusterForMobile" resultMap="ClusterInfoMobile-result" parameterClass="Cluster">
      SELECT ci.cluster_no, ci.user_id, ci.cluster_name, ci.cluster_info, ci.enable
      FROM public.cluster_member as cm
      INNER JOIN cluster_info as ci
      ON cm.cluster_no = ci.cluster_no
      where cluster_enable = #cluster_enable# and cm.user_id = #user_id#
    </select>

    <select id="SelectClusterMember" resultMap="ClusterMember-result" parameterClass="ClusterMember">
      SELECT *
      FROM public.cluster_member
      INNER JOIN user_info
      ON cluster_member.user_id = user_info.user_id
      <dynamic prepend="where">
        <isNotEmpty prepend="and" property="cluster_no">
          cluster_no = $cluster_no$
        </isNotEmpty>
        <isNotEmpty prepend="and" property="user_id">
          cluster_member.user_id = #user_id#
        </isNotEmpty>
      </dynamic>
    </select>

    <select id="SelectClusterMemberList" resultMap="ClusterMember-result" parameterClass="ClusterMember">
      SELECT *
      FROM public.cluster_member
      INNER JOIN user_info
      ON cluster_member.user_id = user_info.user_id
      where ( cluster_enable = '1' or cluster_enable = '2')
      <dynamic prepend="">
        <isNotEmpty prepend="and" property="cluster_no">
          cluster_no = $cluster_no$
        </isNotEmpty>
      </dynamic>
      ORDER BY cluster_enable
    </select>

    <!--查詢非聚落成員(手機)-->
    <select id="SelectClusterMemberList" resultMap="ClusterMember-result" parameterClass="ClusterMember">
      <![CDATA[
      SELECT *
      FROM public.cluster_member
      INNER JOIN user_info
      ON cluster_member.user_id = user_info.user_id
      where ( cluster_enable = '1' or cluster_enable = '2')
      <dynamic prepend="">
        <isNotEmpty prepend="and" property="cluster_no">
          cluster_no = $cluster_no$
        </isNotEmpty>
      </dynamic>
      ORDER BY cluster_enable
      ]]>
    </select>

    <!--新增聚落-->
    <insert id="ClusterInfoInsertOne" parameterClass="ClusterInfo">
      <selectKey resultClass="int" property="cluster_no" type="post">
        SELECT currval('cluster_info_cluster_no_seq')
      </selectKey>
      INSERT INTO public.cluster_info(
      user_id, cluster_name, cluster_info, enable )
      VALUES (#user_id#,#cluster_name#,#cluster_info#,#enable#)
    </insert>

    <!--更新聚落-->
    <update id="ClusterInfoUpdateOne" parameterClass="ClusterInfo">
      UPDATE public.cluster_info
      SET cluster_name=#cluster_name#, cluster_info=#cluster_info#, update_time=now()
      WHERE cluster_no=$cluster_no$
    </update>

    <!--新增聚落會員-->
    <insert id="ClusterMemberInsertOne" parameterClass="ClusterMember">
      <selectKey resultClass="int" property="cluster_member_no" type="post">
        SELECT currval('cluster_member_cluster_member_no_seq')
      </selectKey>
      INSERT INTO public.cluster_member(
      cluster_no, user_id, cluster_enable, "limit" )
      VALUES ($cluster_no$,#user_id#,#cluster_enable#,#limit#)
    </insert>

    <!--更新聚落會員狀態-->
    <update id="ClusterMemberUpdateOne" parameterClass="ClusterMember">
      UPDATE public.cluster_member
      SET cluster_enable=#cluster_enable#
      WHERE cluster_no=$cluster_no$ AND user_id=#user_id#
    </update>

  </statements>

  <resultMaps>


    <resultMap id="Cluster-result" class="prj_BIZ_System.Models.ClusterModel">
      <!--property是Model屬性,column是資料庫欄位名稱-->
      <result property="user_id" column="user_id"></result>
      <result property="cluster_no" column="cluster_no"></result>
      <result property="cluster_name" column="cluster_name"></result>
      <result property="cluster_info" column="cluster_info"></result>
      <result property="enable" column="enable"></result>
      <result property="cluster_enable" column="cluster_enable"></result>
      <result property="limit" column="limit"></result>
    </resultMap>

    <resultMap id="ClusterInfoMobile-result" class="prj_BIZ_System.WebService.Model.ClusterInfo">
      <!--property是Model屬性,column是資料庫欄位名稱-->
      <result property="cluster_no" column="cluster_no"></result>
      <result property="user_id" column="user_id"></result>
      <result property="cluster_name" column="cluster_name"></result>
      <result property="cluster_info" column="cluster_info"></result>
      <result property="enable" column="enable"></result>
    </resultMap>

    <resultMap id="ClusterInfo-result" class="prj_BIZ_System.Models.ClusterInfoModel">
      <!--property是Model屬性,column是資料庫欄位名稱-->
      <result property="cluster_no" column="cluster_no"></result>
      <result property="user_id" column="user_id"></result>
      <result property="cluster_name" column="cluster_name"></result>
      <result property="cluster_info" column="cluster_info"></result>
      <result property="create_time" column="create_time"></result>
      <result property="update_time" column="update_time"></result>
      <result property="enable" column="enable"></result>
    </resultMap>

      <resultMap id="ClusterMember-result" class="prj_BIZ_System.Models.ClusterMemberModel">
      <!--property是Model屬性,column是資料庫欄位名稱-->
      <result property="cluster_member_no" column="cluster_member_no"></result>
      <result property="cluster_no" column="cluster_no"></result>
      <result property="user_id" column="user_id"></result>
      <result property="cluster_enable" column="cluster_enable"></result>
      <result property="create_time" column="create_time"></result>
      <result property="limit" column="limit"></result>
      <result property="company" column="company"></result>
    </resultMap>
  
  </resultMaps>

</sqlMap>

