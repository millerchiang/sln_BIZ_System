@using prj_BIZ_System.Models
@model prj_BIZ_System.Models.Match_ViewModel

@{
    ViewBag.Title = "MatchScheduleList";
}

@{
    int sellerIdCount = 0;
}

@{
    <link href="~/stylesheets/sys.css" rel="stylesheet" />
}

<div class="article_col1">
    <article>
        <form id="form" action="@ViewBag.Action" method="post">
            <h2 class="borderTitle2">媒合時程大表</h2>
            <a href="" class="addbublue rightbox">匯出Excel</a>
            <a href="javascript:return false;" class="addbublue rightbox" id="saveMatchData">儲存</a>
            <table class="edittable">
                <thead>

                    <tr>
                        <th>
                            <div class="centerbox">
                                <a href="@Url.Action("MatchScheduleTime","Manager",new { activity_id = Model.SchedulePeriodSet.activity_id})" class="addbu">設定時段</a>
                            </div>
                        </th>
                        @foreach (BuyerInfoModel buyerInfoModel in Model.buyerinfoList)
                        {
                            <th class="centerbox2">
                                @buyerInfoModel.company
                            <input type="hidden" name="buyer_id" value="@buyerInfoModel.buyer_id" />
                        </th>

                        }
                    </tr>

                </thead>
                <tbody>
                    @for (int i = 0; i < Model.schedulePeriodSetList.Count; i++)
                    {
                        <tr>
                            <td>
                                @Model.schedulePeriodSetList[i].time_start.ToString("HH:mm")
                                ~@Model.schedulePeriodSetList[i].time_end.ToString("HH:mm")
                                <input type="hidden" name="period_sn" value="@Model.schedulePeriodSetList[i].period_sn" />
                                <input type="hidden" name="activity_id" value="@Model.schedulePeriodSetList[i].activity_id" />
                            </td>
                            <!-------------------我是分隔線-------------------->

                            @for (int j = 0; j < Model.buyerinfoList.Count; j++)
                            {
                                <td>
                                    <select name="seller_id" id="seller_id@(sellerIdCount++)" onchange="PullDownMenus(@(sellerIdCount-1))">
                                        <option value="">--請選擇--</option>
                                        @foreach (ActivityRegisterModel activityRegisterModel in Model.activityregisterList)
                                        {
                                            if (activityRegisterModel.company == Model.matchMakingScheduleSellerCompany[i * Model.buyerinfoList.Count + j])
                                            {
                                                <option value="@activityRegisterModel.user_id" selected="selected">@activityRegisterModel.company</option>
                                            }
                                            else
                                            {
                                                <option value="@activityRegisterModel.user_id">@activityRegisterModel.company</option>
                                            }
                                        }
                                    </select>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
                <tfoot>

                    <tr class="tfootbg">
                        <td class="centerbox2">雙方有媒合意願</td>
                        @foreach (BuyerInfoModel buyerInfoModel in Model.buyerinfoList)
                        {
                            if (Model.sellerCompanyNamereply1Dic.ContainsKey(buyerInfoModel.buyer_id))
                            {
                                <td class="centerbox2">
                                    @foreach (string sellerName in Model.sellerCompanyNamereply1Dic[buyerInfoModel.buyer_id])
                                    {
                                        <p>@String.Format(sellerName)</p>
                                    }
                                </td>
                            }
                            else {
                                <td class="centerbox2"></td>
                            }
                        }
                    </tr>

                    <tr>
                        <td class="centerbox2">賣方有媒合意願</td>
                        @*@foreach (MatchmakingNeedModel matchmakingNeedModel in Model.matchmakingNeedList)
                            {
                                if (matchmakingNeedModel.buyer_reply == "0")
                                {
                                    <p>@matchmakingNeedModel.company</p>
                                }
                            }*@

                        @foreach (BuyerInfoModel buyerInfoModel in Model.buyerinfoList)
                        {
                            if (Model.sellerCompanyNamereply0Dic.ContainsKey(buyerInfoModel.buyer_id))
                            {
                                <td class="centerbox2">
                                    @foreach (string sellerName in Model.sellerCompanyNamereply0Dic[buyerInfoModel.buyer_id])
                                    {
                                        <p>@String.Format(sellerName)</p>
                                    }
                                </td>
                            }
                            else {
                                <td class="centerbox2"></td>
                            }
                        }
                    </tr>
                </tfoot>
            </table>
        </form>
    </article>
</div>

<script type="text/javascript">
    $(function () {

        /*儲存媒合資料*/
        $("#saveMatchData").click(function () {
            $("#form").submit();
        });

        /*某下拉式選單選擇後橫排及豎排不能複選的功能*/
    });

    function PullDownMenus(sellerIdCount) {
        //console.log(sellerIdCount);
        var sellerCompanys = @Html.Raw(Json.Encode(Model.matchMakingScheduleSellerCompany));
        var allSellers = @Html.Raw(Json.Encode(Model.activityRegisterSellerCompany));
        var selectedSellerValue = $("#seller_id"+sellerIdCount + " option:selected").val();

        var sellerCounts = @Model.matchMakingScheduleSellerCompany.Count();
        var periodCounts = @Model.schedulePeriodSetList.Count();
        var buyerCounts  = @Model.buyerinfoList.Count();

        //console.log(sellerCompanys);
        //console.log(allSellers);
        //console.log(selectedSeller);
        console.log(sellerCounts);
        //console.log(periodCounts);
        //console.log(buyerCounts);
        //console.log(sellerCompanys[sellerIdCount])

        //var selectedSellerIndex = $("#seller_id"+sellerIdCount + " option:selected").index();
        var selectedSellerIndex = $("#seller_id"+sellerIdCount).index();
        /* 0 1 2 3 4 5 */
       
        for(var i = 0; i< sellerCounts; i++)
        {
            if(sellerIdCount != i)
            {         
                //if()
                $("#seller_id"+i+" option[value="+selectedSellerValue+"]").remove();
            }
        }
    }

</script>
